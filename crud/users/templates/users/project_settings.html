{% extends 'layout.html' %}

{% block title %}Project Settings{% endblock %}

{% block content %}
    <h1>{{ project.name }} - Settings</h1>

    <div id="permissions">
        <h2>Assign Permissions</h2>
        <form id="permissions-form">
            <label for="user">User:</label>
            <select id="user" name="user_id">
                {% for member in project.team_members.all %}
                    <option value="{{ member.id }}">{{ member.username }}</option>
                {% endfor %}
            </select>

            <label for="permission_type">Permission:</label>
            <select id="permission_type" name="permission_type">
                <option value="view">View</option>
                <option value="edit">Edit</option>
            </select>

            <button type="submit">Assign</button>
        </form>
    </div>

    <div id="current-permissions">
        <h2>Current Permissions</h2>
        <ul id="permissions-list"></ul>
    </div>

    <script>
        document.getElementById('permissions-form').addEventListener('submit', function(event) {
            event.preventDefault();
            const formData = new FormData(event.target);

            fetch("{% url 'set_permission' pk=project.pk %}", {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': '{{ csrf_token }}',
                },
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('Permission assigned successfully.');
                    loadPermissions();
                } else {
                    alert('Error assigning permission.');
                }
            });
        });

        function loadPermissions() {
            fetch("{% url 'get_permissions' pk=project.pk %}")
            .then(response => response.json())
            .then(data => {
                const list = document.getElementById('permissions-list');
                list.innerHTML = '';
                data.forEach(item => {
                    const listItem = document.createElement('li');
                    listItem.textContent = `${item.user}: ${item.permission_type}`;
                    list.appendChild(listItem);
                });
            });
        }

        document.addEventListener('DOMContentLoaded', loadPermissions);
    </script>
{% endblock %}
